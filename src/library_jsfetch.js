mergeInto(LibraryManager.library, {
  jsfetch_init: function(){if(Module.initialized){return}Module.MAX_FETCH_ATTEMPTS=6;Module.MAX_READ_ATTEMPTS=6;Module.MAX_SIZE_TO_SKIP_ON_READ_FAILURE=41943040;Module.FETCH_TIMEOUT=Module.FETCH_TIMEOUT||30*1e3;Module.READ_TIMEOUT=Module.READ_TIMEOUT||30*1e3;Module.INITIAL_RETRY_DELAY=Module.INITIAL_RETRY_DELAY||250;Module.libavjsJSFetch={ctr:1,fetches:{},pos:0,read_failures:0};Module.abortController=new AbortController;Module.readFailureMap=new Map;Module.initialized=true},
  jsfetch_set_fetch_timeout_js: function(ms){Module.FETCH_TIMEOUT=ms},
  jsfetch_set_read_timeout_js: function(ms){Module.READ_TIMEOUT=ms},
  jsfetch_set_initial_retry_delay_js: function(ms){Module.INITIAL_RETRY_DELAY=ms},
  jsfetch_get_code: function(){return Module.returnCode||0},
  jsfetch_abort: function(){const abortController=Module.abortController;if(abortController){abortController.abort(`Download aborted by user`)}else{Module.abortController=new AbortController;Module.abortController.abort(`Download aborted by user`)}},
  jsfetch_set_bypass_cache_js: function(bypass){Module.bypassCache=bypass},
  jsfetch_abort_individual: function(idx){const jsfo=Module.libavjsJSFetch.fetches[idx];if(!jsfo){return}jsfo.buf=null;jsfo.abortController.abort()},
  jsfetch_open_js: function jsfetch_open_js(url,range_header,has_range,force_idx,probe_range_support){return Asyncify.handleAsync(async function(){if(Module.abortController.signal.aborted){console.warn("jsfetch_open_js aborted.");return-1415072069}url=UTF8ToString(url);const fetchUrl=url.startsWith("jsfetch:")?url.slice(8):url;if(url.endsWith(".m3u8")||url.endsWith(".mpd")){probe_range_support=false}let headers={};let range;if(has_range){range=range_header?UTF8ToString(range_header):undefined;headers.Range=range}else if(probe_range_support){headers.Range="bytes=0-"}const requestAbortController=new AbortController;const combinedSignal=AbortSignal.any([requestAbortController.signal,Module.abortController.signal]);let response;if(probe_range_support){response=await Module.FetchWithRetry(fetchUrl,headers,1,Module.FETCH_TIMEOUT,Module.INITIAL_RETRY_DELAY,Module.bypassCache,combinedSignal);if(!response.ok){delete headers.Range}}if(!probe_range_support||!response.ok){response=await Module.FetchWithRetry(fetchUrl,headers,Module.MAX_FETCH_ATTEMPTS,Module.FETCH_TIMEOUT,Module.INITIAL_RETRY_DELAY,Module.bypassCache,combinedSignal);if(response.aborted){return-1415072069}else if(response.timeout){Module.returnCode=1003;return-541478725}else if(response instanceof Error){Module.returnCode=1001;return-541478725}else if(response.err_status){Module.returnCode=response.err_status;return-541478725}}const idx=force_idx?force_idx:Module.libavjsJSFetch.ctr++;const accept_range=(response.headers.get("accept-ranges")||"").toLowerCase();const content_range=response.headers.get("content-range");const support_range=accept_range&&accept_range=="bytes"||response.status==206&&content_range!=undefined;const content_length=parseInt(response.headers.get("content-length")||"0",10);let total_size=0;if(content_range){const match=content_range.match(/bytes \d+-\d+\/(\d+)/);total_size=match?parseInt(match[1]):0}else if(content_length){const jsfo=Module.libavjsJSFetch.fetches[idx];const previous_size=jsfo?jsfo.total_size:0;if(!previous_size){total_size=content_length}}const reader=response.body.getReader();combinedSignal.addEventListener("abort",async()=>{try{await reader.cancel()}catch(e){}});const pos=range?Number(range.match(/bytes=(\d+)/)?.[1]??0):0;Module.libavjsJSFetch.fetches[idx]={abortController:requestAbortController,url,reader,support_range,total_size,pos,first_read:true,buf:null,rej:null};return idx})},
  jsfetch_support_range_js: function(idx){const jsfo=Module.libavjsJSFetch.fetches[idx];return jsfo&&jsfo.support_range?1:0},
  jsfetch_get_size_js: function(idx){const jsfo=Module.libavjsJSFetch.fetches[idx];return jsfo?jsfo.total_size:0},
  jsfetch_get_pos_js: function(idx){const jsfo=Module.libavjsJSFetch.fetches[idx];return jsfo?jsfo.pos:0},
  jsfetch_read_js: function jsfetch_read_js(idx,toBuf,size){return Asyncify.handleAsync(async function(){const self=async function(){const jsfo=Module.libavjsJSFetch.fetches[idx];if(Module.abortController.signal.aborted||!jsfo){console.warn("jsfetch_read_js aborted.");return-1415072069}try{if(jsfo.buf&&jsfo.buf.value&&jsfo.buf.value.length>0){const chunk=jsfo.buf.value;const len=Math.min(size,chunk.length);Module.HEAPU8.set(chunk.subarray(0,len),toBuf);jsfo.buf.value=chunk.subarray(len);if(jsfo.buf.value.length===0){jsfo.buf=null}jsfo.pos+=len;return len}const thisReadAbortController=new AbortController;const combinedSignal=AbortSignal.any([thisReadAbortController.signal,Module.abortController.signal]);const timeout_p=Module.DoAbortableSleep(Module.READ_TIMEOUT,combinedSignal);const read_p=jsfo.reader.read();const race_res=await Promise.race([timeout_p,read_p]);thisReadAbortController.abort();if(race_res.timeout_id){clearTimeout(race_res.timeout_id)}if(race_res.aborted){return-1415072069}else if(race_res.timed_out){await jsfo.reader.cancel();throw`Timed out after ${Module.READ_TIMEOUT} ms.`}if(race_res.done){return-541478725}Module.libavjsJSFetch.read_failures=0;let chunk=race_res.value;const skip_bytes=Module.readFailureMap.get(idx);if(skip_bytes>jsfo.pos){const bytes_to_skip=skip_bytes-jsfo.pos;if(bytes_to_skip>=chunk.length){jsfo.pos+=chunk.length;return self()}else{chunk=chunk.subarray(bytes_to_skip);jsfo.pos+=bytes_to_skip;Module.readFailureMap.delete(idx)}}if(jsfo.first_read){jsfo.first_read=false;const png_index=Module.FindPngSliceIndex(chunk);if(png_index>=0){chunk=chunk.subarray(png_index);jsfo.pos+=png_index}}const len=Math.min(size,chunk.length);Module.HEAPU8.set(chunk.subarray(0,len),toBuf);if(chunk.length>len){jsfo.buf={value:chunk.subarray(len)}}else{jsfo.buf=null}jsfo.pos+=len;return len}catch(e){if(jsfo.abortController.signal.aborted||Module.abortController.signal.aborted){console.warn("jsfetch_read_js aborted.");return-1415072069}console.warn("jsfetch_read_js error",e);Module.libavjsJSFetch.read_failures++;const too_big_to_retry_without_seek=jsfo.total_size>Module.MAX_SIZE_TO_SKIP_ON_READ_FAILURE;if(Module.libavjsJSFetch.read_failures>=Module.MAX_READ_ATTEMPTS||!jsfo.support_range&&too_big_to_retry_without_seek){console.warn(`Cant retry. read_failures: ${Module.libavjsJSFetch.read_failures}, too_big: ${too_big_to_retry_without_seek}`);Module.returnCode=1002;return-541478725}const delay=Math.pow(2,Module.libavjsJSFetch.read_failures)*Module.INITIAL_RETRY_DELAY;console.warn(`Retrying read in ${delay} ms`);const combinedSignal=AbortSignal.any([jsfo.abortController.signal,Module.abortController.signal]);const abort_sleep_res=await Module.DoAbortableSleep(delay,combinedSignal);if(abort_sleep_res.timeout_id){clearTimeout(abort_sleep_res.timeout_id)}if(abort_sleep_res.aborted){return-1415072069}if(!jsfo.support_range){console.warn(`Retrying without range support, will skip ${jsfo.pos} bytes`);const existing=Module.readFailureMap.get(idx)||0;const skip_bytes=Math.max(existing,jsfo.pos);Module.readFailureMap.set(idx,skip_bytes);return-1001}console.warn(`Retrying with range support from ${jsfo.pos}`);return-1e3}};return self()})},
  jsfetch_close_js: function(idx){const jsfo=Module.libavjsJSFetch.fetches[idx];if(jsfo){jsfo.reader.cancel().catch(e=>{});jsfo.abortController.abort();delete Module.libavjsJSFetch.fetches[idx]}},
